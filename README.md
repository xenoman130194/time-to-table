# Time-To-Table v0.6.6 (Калькулятор для ленивых)

> автор: Галимзянов Г.Р.

Эта программа распространяется бесплатно. 

Автор добровольно отказывается от получения оплаты за использование.

Это калькулятор для расчёта графиков работ. Сделан на Tauri чтоб работал как нормальная программа, а не в браузере.

Цель создания - ускорение ввода данных в SAP, после выгрузки .xls данные из него копируются -> в SAP ручками через ctrl-c/v.

---

## Что умеет

## Основное

- Расчёт графика - вбиваешь операции, время, исполнителей и оно само считает когда что начинается/заканчивается
- Режим цепочка - когда включен, следующий расчёт начинается с конца предыдущего (чтоб уместить все операции в один день)
- Учёт обедов - можно задать 2 обеда (дневной и ночной как в ОР), программа сама сдвигает время если операция попадает на обед
- Техкарты (шаблоны) - можно сохранить набор операций и потом загружать одной кнопкой

## Экспорт/Импорт

- Экспорт в Excel (.xls) - выгружает всю историю расчётов в файл, формулы работают (можно менять время и пересчитается)
- Экспорт JSON - сохраняет техкарты в файл
- Импорт JSON - загружает техкарты из файла

## История

- Можно скачать историю в Excel
- Можно очистить историю

## Z7

- Генерирует текст для Z7 отчёта
- В Excel тоже выгружается

---

## Горячие клавиши

| Комбинация | Что делает |
|------------|------------|
| F12 | DevTools (только в dev режиме) |

*больше пока нету, надо бы добавить*

---

## Технический долг

### Что надо бы сделать но руки не дошли
   
**prompt() для названия техкарты** - используется браузерный prompt а не нативный диалог Tauri (в Tauri v2 нет встроенного prompt с вводом текста)

**localStorage**
   - основные пользовательские данные (история, техкарты, настройки) хранятся в LocalStorage WebView2
   - нативные файлы (экспорт JSON / Excel) сохраняются через Tauri/Rust в выбранную папку (Загрузки/Документы/Рабочий стол)
   - при очистке профиля WebView2 или кэша эти данные могут быть потеряны
   - нет автоматической синхронизации между машинами; рекомендуется экспорт/импорт JSON для бэкапа
   - для надёжности и конфиденциальности имеет смысл использовать файл-основанное хранилище (JSON/SQLite) или шифрование
   

**Нет настроек** - всё захардкожено (время обеда по умолчанию, цвета и тд)

**Excel файл это на самом деле XML** - Excel ругается при открытии что формат не соответствует расширению (но открывает нормально)

**Иконка дефолтная** - надо нарисовать нормальную

**Типизация** - весь JS без TypeScript, где-то могут быть баги с типами

---

## Известные баги и недочёты

### Баги
- [ ] Если быстро кликать по кнопкам, иногда дублируются записи в истории
- [ ] При очень длинных названиях операций таблица может поехать
- [ ] Если localStorage переполнится - всё сломается (но это надо очень постараться)

### Недочёты
- [ ] Нельзя редактировать историю (либо Last-In, First-Out; либо удалить всю)
- [ ] Нет отмены действий (Ctrl+Z не работает)
- [ ] Нельзя изменить порядок операций перетаскиванием
- [ ] Нет тёмной темы
- [ ] Печать не настроена (Ctrl+P работает но криво)

---

## Безопасность

### Что сделано
- **CSP без unsafe-inline** - инлайн скрипты заблокированы

- **Валидация входных данных** - sanitizeInput, validateNumber, clamp

- **Защита от prototype pollution** - sanitizeObject, safeJsonParse

- **Безопасный парсинг JSON** - все JSON.parse обёрнуты в safeJsonParse с санитизацией

- **Файлы можно сохранять только в**: Загрузки, Документы, Рабочий стол

- **Защита от path traversal атак** (../) через canonicalize в Rust

- **DevTools отключён** в релизной сборке

- **maxlength на текстовых полях** - защита от переполнения

- **Нативные диалоги** вместо браузерных alert/confirm

- **Без innerHTML** - везде используется textContent и createEl

- **Блокировка on атрибутов** в createEl для предотвращения XSS

- **Экранирование XML** - escapeXml для всех пользовательских данных в Excel

- **Лимит размера файла** - импорт JSON ограничен 1 МБ

- **Валидация импорта** - validateImportData проверяет структуру и блокирует __proto__

### Как работает ограничение путей
Диалог показывает все папки (пользователь может смотреть), но при попытке сохранить файл куда попало - Rust проверяет путь и блокирует если он не в разрешённой директории. Выскочит ошибка "Сохранение разрешено только в папки: Загрузки, Документы или Рабочий стол"

### Что не сделано

**Данные не шифруются** - техкарты лежат в localStorage открытым текстом.

**Нет аутентификации** - любой кто запустил программу имеет полный доступ

**exe не подписан** - Windows может ругаться "неизвестный издатель", антивирусы могут блокировать

**WebView2 зависимость** - если на компе нет WebView2 Runtime, программа скачает его из интернета. В офлайн среде может не запуститься

**localStorage не бэкапится** - если что-то случится с диском, данные потеряются. Надо периодически делать "Экспорт JSON"

---

## Структура проекта 

```
tauri-app/
├── .gitignore
├── LICENSE
├── package.json            # npm скрипты и команды сборки
├── package-lock.json       # lock-файл npm (рекомендуется хранить в репозитории)
├── README.md               # документация проекта
├── node_modules/           # локальные зависимости (обычно в .gitignore)
├── src/                    # фронтенд (WebView)
│   ├── index.html          # разметка
│   ├── styles.css          # стили (CSP-friendly)
│   ├── main.js             # логика фронтенда
│   └── about.txt           # текст для окна "О программе"
├── src-tauri/              # конфигурация и код бэкенда (Rust + Tauri)
│   ├── Cargo.toml          # зависимости Rust
│   ├── Cargo.lock          # lock-файл Cargo (если есть)
│   ├── tauri.conf.json     # конфиг Tauri
│   ├── build.rs            # (если используется)
│   ├── src/                # исходники Rust
│   │   ├── main.rs         # точка входа (команды/bridge)
│   │   └── lib.rs          # библиотечная логика
│   ├── capabilities/       # разрешения
│   │   └── default.json
│   ├── gen/                # сгенерированные/описательные схемы
│   │   └── schemas/
│   │       ├── acl-manifests.json
│   │       ├── capabilities.json
│   │       ├── desktop-schema.json
│   │       └── windows-schema.json
│   ├── icons/              # иконки приложения (много размеров/платформ)
│   │   ├── icon.ico
│   │   ├── icon.png
│   │   ├── icon.icns
│   │   └── (другие размеры и папки: android/, ios/, ...)
│   └── target/             # артефакты сборки (в .gitignore)
```

---

## Где хранятся данные

```
C:\Users\<ИМЯ>\AppData\Local\com.timetotable.calculator\
└── EBWebView\Default\Local Storage\
```

Путь приведён как пример — фактическое расположение профиля WebView2 зависит от идентификатора приложения и платформы.

Если нужно сбросить все данные локально, можно удалить соответствующую папку профиля WebView2 (внимание: это удалит все WebView данные).

---

## Зависимости

### Rust (бэкенд)
- tauri v2
- tauri-plugin-dialog v2
- tauri-plugin-fs v2
- tauri-plugin-opener v2
- serde, serde_json

### JS (фронтенд)
- ничего, ванильный JS

---

## Сборка

Краткие команды для разработки и сборки (Windows):

```
npm install
npm run dev   # запустить в режиме разработки (WebView2)
npm run build   # Для релизной сборки, если настроено:
tauri build   # или 
```

Примечание: для сборки требуется установленный Rust toolchain и WebView2 Runtime на целевой машине.


## TODO (когда-нибудь)

- [ ] Добавить проверку SHA256 exe (уже есть код но не интегрирован)
- [ ] Сделать нормальную иконку
- [ ] Добавить настройки (тема, дефолтное время обеда итд)
- [ ] Разбить main.js на модули
- [ ] Добавить TypeScript, а надо ли?
- [ ] Добавить горячие клавиши
- [ ] Подписать exe сертификатом
- [x] Сделать portable версию (без установки)

---

## Changelog

### v0.6.6

- Обновление модальных окон и UX:
- Усилена логика модального окна исполнителей и операций (правки расположения, выравнивание колонок, поведение кнопок «Сохранить/Сбросить/Изменить»).
- Добавлена «шпаргалка» (локальная заметка) в модальном окне исполнителей — теперь поле сохраняется локально и по умолчанию не включается в экспорт.

- Безопасность и санитизация:
- Дополнительная валидация и жёсткая санитизация полей ввода (`sanitizeInput`, валидация времени/единиц), защита от Excel‑формул и prototype pollution.
- Нормализация номеров исполнителей: метки возвращают только цифры и дополняются до 8 знаков, если возможно.

- Экспорт и совместимость:
- `z7_workers_cheat` исключён из JSON‑экспорта (локальные заметки остаются приватными).
- Увеличена ширина столбца «№» в экспортируемом Excel, чтобы корректно отображать 8‑значные номера подтверждения.
- Исправления и мелкие улучшения:
- Исправлен порядок инициализации переменных, устраняющий возможный TDZ (ReferenceError).
- Разные правки и оптимизации в `main.js` (улучшение отображения, проверки диапазонов, обработка вставки из буфера).

### v0.6.5

- Небольшие улучшения безопасности и UX:
- Мелкие правки стилей модального окна (меньше отступов, компактный вид).
- Добавлена возможность задать 8-значные номера исполнителей через модальное окно; при отсутствии номеров используются порядковые номера.
- Улучшена санитизация при экспорте в Excel (включая номера исполнителей) для защиты от формульной инъекции.
- Небольшие оптимизации и проверки ввода в `main.js`.

### v0.6.4

- Небольшие улучшения и исправления:
- Добавлено окно "О программе" (модальное окно с подгружаемым текстом из src/about.txt).
- Единицы измерения времени теперь задаются только в первой операции; остальные операции наследуют выбранную единицу (мин/час) и неактивны для выбора.
- Обновлена версия приложения в манифестах и исходных файлах до 0.6.4.

### v0.6.3

- Обновлена версия приложения до 0.6.3 (манифесты, UI title, документация).
- Небольшие правки README.

### v0.6.2

- Удалены сгенерированные артефакты сборки (`src-tauri/target/`) из репозитория.
- Semgrep workflow отключен/удален из CI.

### v0.6.1

- Перенос на Tauri v2
- Нативные диалоги сохранения/подтверждения
- Исправлен CSP (убран unsafe-inline)
- Защита от prototype pollution
- Исправлена установка текущей даты при запуске

### v0.6.0

- Последняя браузерная версия (до Tauri)

---

## Лицензия

GNU GPL 3.0

---

*последнее обновление: февраль 2026*
