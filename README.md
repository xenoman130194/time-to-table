# Time-SAP v0.6.2 (Калькулятор для ленивых)

> автор: Галимзянов Г.Р.

Это калькулятор для расчёта графиков работ. Сделан на Tauri чтоб работал как нормальная программа а не в браузере.

Цель создания - ускорение ввода данных в SAP, после выгрузки .xls данные из него копируются -> в SAP ручками через ctrl-c/v.

---

## Что умеет

## Основное

- Расчёт графика - вбиваешь операции, время, исполнителей и оно само считает когда что начинается/заканчивается
- Режим цепочка - когда включен, следующий расчёт начинается с конца предыдущего (чтоб уместить все операции в один день)
- Учёт обедов - можно задать 2 обеда (дневной и ночной как в ОР), программа сама сдвигает время если операция попадает на обед
- Техкарты (шаблоны) - можно сохранить набор операций и потом загружать одной кнопкой

## Экспорт/Импорт

- Экспорт в Excel (.xls) - выгружает всю историю расчётов в файл, формулы работают (можно менять время и пересчитается)
- Экспорт JSON - сохраняет техкарты в файл
- Импорт JSON - загружает техкарты из файла

## История

- Можно скачать историю в Excel
- Можно очистить историю

## Z7

- Генерирует текст для Z7 отчёта
- В Excel тоже выгружается

---

## Горячие клавиши

| Комбинация | Что делает |
|------------|------------|
| F12 | DevTools (только в dev режиме) |

*больше пока нету, надо бы добавить*

---

## Технический долг

### Что надо бы сделать но руки не дошли
   
**prompt() для названия техкарты** - используется браузерный prompt а не нативный диалог Tauri (в Tauri v2 нет встроенного prompt с вводом текста)

**localStorage**
   - основные пользовательские данные (история, техкарты, настройки) хранятся в LocalStorage WebView2
   - нативные файлы (экспорт JSON / Excel) сохраняются через Tauri/Rust в выбранную папку (Загрузки/Документы/Рабочий стол)
   - при очистке профиля WebView2 или кэша эти данные могут быть потеряны
   - нет автоматической синхронизации между машинами; рекомендуется экспорт/импорт JSON для бэкапа
   - для надёжности и конфиденциальности имеет смысл использовать файл-основанное хранилище (JSON/SQLite) или шифрование
   

**Нет настроек** - всё захардкожено (время обеда по умолчанию, цвета и тд)

**Excel файл это на самом деле XML** - Excel ругается при открытии что формат не соответствует расширению (но открывает нормально)

**Иконка дефолтная** - надо нарисовать нормальную

**Типизация** - весь JS без TypeScript, где-то могут быть баги с типами

---

## Известные баги и недочёты

### Баги
- [ ] Если быстро кликать по кнопкам, иногда дублируются записи в истории
- [ ] При очень длинных названиях операций таблица может поехать
- [ ] Если localStorage переполнится - всё сломается (но это надо очень постараться)

### Недочёты
- [ ] Нельзя редактировать историю (либо Last-In, First-Out; либо удалить всю)
- [ ] Нет отмены действий (Ctrl+Z не работает)
- [ ] Нельзя изменить порядок операций перетаскиванием
- [ ] Нет тёмной темы
- [ ] Печать не настроена (Ctrl+P работает но криво)

---

## Безопасность

### Что сделано
- **CSP без unsafe-inline** - инлайн скрипты заблокированы

- **Валидация входных данных** - sanitizeInput, validateNumber, clamp

- **Защита от prototype pollution** - sanitizeObject, safeJsonParse

- **Безопасный парсинг JSON** - все JSON.parse обёрнуты в safeJsonParse с санитизацией

- **Файлы можно сохранять только в**: Загрузки, Документы, Рабочий стол

- **Защита от path traversal атак** (../) через canonicalize в Rust

- **DevTools отключён** в релизной сборке

- **maxlength на текстовых полях** - защита от переполнения

- **Нативные диалоги** вместо браузерных alert/confirm

- **Без innerHTML** - везде используется textContent и createEl

- **Блокировка on* атрибутов** в createEl для предотвращения XSS

- **Экранирование XML** - escapeXml для всех пользовательских данных в Excel

- **Лимит размера файла** - импорт JSON ограничен 1 МБ

- **Валидация импорта** - validateImportData проверяет структуру и блокирует __proto__

### Как работает ограничение путей
Диалог показывает все папки (пользователь может смотреть), но при попытке сохранить файл куда попало - Rust проверяет путь и блокирует если он не в разрешённой директории. Выскочит ошибка "Сохранение разрешено только в папки: Загрузки, Документы или Рабочий стол"

### Что не сделано

**Данные не шифруются** - техкарты лежат в localStorage открытым текстом.

**Нет аутентификации** - любой кто запустил программу имеет полный доступ

**exe не подписан** - Windows может ругаться "неизвестный издатель", антивирусы могут блокировать

**WebView2 зависимость** - если на компе нет WebView2 Runtime, программа скачает его из интернета. В офлайн среде может не запуститься

**localStorage не бэкапится** - если что-то случится с диском, данные потеряются. Надо периодически делать "Экспорт JSON"

---

## Структура проекта

```
tauri-app/
├── src/                    # Фронтенд
│   ├── index.html          # Разметка
│   ├── styles.css          # Стили  
│   └── main.js             # Вся логика (1400+ строк, надо бы разбить)
├── src-tauri/              # Бэкенд (Rust)
│   ├── src/
│   │   └── lib.rs          # Точка входа + команды
│   ├── capabilities/
│   │   └── default.json    # Разрешения
│   ├── icons/              # Иконки
│   ├── Cargo.toml          # Зависимости Rust
│   └── tauri.conf.json     # Конфиг Tauri
└── package.json            # npm скрипты
```

---

## Где хранятся данные

```
C:\Users\<ИМЯ>\AppData\Local\com.timesap.calculator\
└── EBWebView\Default\Local Storage\
```

Путь приведён как пример — фактическое расположение профиля WebView2 зависит от идентификатора приложения и платформы.

Если нужно сбросить все данные локально, можно удалить соответствующую папку профиля WebView2 (внимание: это удалит все WebView данные).

---

## Зависимости

### Rust (бэкенд)
- tauri v2
- tauri-plugin-dialog v2
- tauri-plugin-fs v2
- tauri-plugin-opener v2
- serde, serde_json

### JS (фронтенд)
- ничего, ванильный JS

---

## Сборка

Краткие команды для разработки и сборки (Windows):

```
npm install
npm run dev   # запустить в режиме разработки (WebView2)
# Для релизной сборки, если настроено:
npm run build
# или
tauri build
```

Примечание: для сборки требуется установленный Rust toolchain и WebView2 Runtime на целевой машине.


## TODO (когда-нибудь)

- [ ] Добавить проверку SHA256 exe (уже есть код но не интегрирован)
- [ ] Сделать нормальную иконку
- [ ] Добавить настройки (тема, дефолтное время обеда итд)
- [ ] Разбить main.js на модули
- [ ] Добавить TypeScript, а надо ли?
- [ ] Добавить горячие клавиши
- [ ] Подписать exe сертификатом
- [х] Сделать portable версию (без установки)

---

## Changelog

-### v0.6.2

- Удалены сгенерированные артефакты сборки (`src-tauri/target/`) из репозитория.
- Semgrep workflow отключен/удален из CI.

-### v0.6.1

- Перенос на Tauri v2
- Нативные диалоги сохранения/подтверждения
- Исправлен CSP (убран unsafe-inline)
- Защита от prototype pollution
- Исправлена установка текущей даты при запуске

### v0.6.0

- Последняя браузерная версия (до Tauri)

---

## Лицензия

Пока никакая. Для личного использования.

---

*последнее обновление: февраль 2026*
